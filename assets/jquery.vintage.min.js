/**
 * vintageJS - add a retro/vintage effect to images using the HTML5 canvas element
 *
 * @license Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 * @author Robert Fleischmann
 * @version 1.1.0
 */
(function(h,p,y){h.fn.vintage=function(z,A){var B=function(q,h,v){if(!1===q instanceof HTMLImageElement)throw"The element (1st parameter) must be an instance of HTMLImageElement";var j,r,w,l,n,s,f,g,t=y.createElement("canvas"),e=t.getContext("2d"),m={onStart:function(){},onStop:function(){},onError:function(){},mime:"image/jpeg"},x={curves:!1,screen:!1,desaturate:!1,vignette:!1,lighten:!1,noise:!1,viewFinder:!1,sepia:!1};r=function(c){m.onStart();var e={},a;for(a in x)e[a]=c[a]||x[a];n=new Image;
n.onload=function(){f=t.width=n.width;g=t.height=n.height;l=[];e.viewFinder&&l.push(e.viewFinder);j(function(){w(e)})};n.onerror=m.onError;n.src=s};j=function(c){if(0===l.length)return c();var k=l.pop(),a=[f,g,k].join("-");if(p.vjsImageCache&&p.vjsImageCache[a])return j(c);var d=new Image;d.onload=function(){e.clearRect(0,0,f,g);e.drawImage(d,0,0,f,g);(p.vjsImageCache||(p.vjsImageCache={}))[a]=e.getImageData(0,0,f,g).data;j(c)};d.onerror=m.onError;d.src=k};w=function(c){var k,a;e.clearRect(0,0,f,
g);e.drawImage(n,0,0,f,g);if(c.vignette||c.lighten)k=Math.sqrt(Math.pow(f/2,2)+Math.pow(g/2,2));c.vignette&&(e.globalCompositeOperation="source-over",a=e.createRadialGradient(f/2,g/2,0,f/2,g/2,k),a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(0.5,"rgba(0,0,0,0)"),a.addColorStop(1,["rgba(0,0,0,",c.vignette,")"].join("")),e.fillStyle=a,e.fillRect(0,0,f,g));c.lighten&&(e.globalCompositeOperation="lighter",a=e.createRadialGradient(f/2,g/2,0,f/2,g/2,k),a.addColorStop(0,["rgba(255,255,255,",c.lighten,
")"].join("")),a.addColorStop(0.5,"rgba(255,255,255,0)"),a.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=a,e.fillRect(0,0,f,g));k=e.getImageData(0,0,f,g);var d,h,j,b=k.data;c.viewFinder&&(viewFinderImageData=p.vjsImageCache[[f,g,c.viewFinder].join("-")]);for(var l=f*g;0<=l;--l){a=l<<2;c.curves&&(b[a]=c.curves.r[b[a]],b[a+1]=c.curves.g[b[a+1]],b[a+2]=c.curves.b[b[a+2]]);c.screen&&(b[a]=255-(255-b[a])*(255-c.screen.r*c.screen.a)/255,b[a+1]=255-(255-b[a+1])*(255-c.screen.g*c.screen.a)/255,b[a+2]=255-(255-
b[a+2])*(255-c.screen.b*c.screen.a)/255);c.noise&&(d=c.noise-Math.random()*c.noise/2,b[a]+=d,b[a+1]+=d,b[a+2]+=d);c.viewFinder&&(b[a]=b[a]*viewFinderImageData[a]/255,b[a+1]=b[a+1]*viewFinderImageData[a+1]/255,b[a+2]=b[a+2]*viewFinderImageData[a+2]/255);c.sepia&&(d=b[a],h=b[a+1],j=b[a+2],b[a]=0.393*d+0.769*h+0.189*j,b[a+1]=0.349*d+0.686*h+0.168*j,b[a+2]=0.272*d+0.534*h+0.131*j);c.desaturate&&(d=(b[a]+b[a+1]+b[a+2])/3,b[a]+=(d-b[a])*c.desaturate,b[a+1]+=(d-b[a+1])*c.desaturate,b[a+2]+=(d-b[a+2])*c.desaturate);
for(d=2;0<=d;--d)b[a+d]=~~(255<b[a+d]?255:0>b[a+d]?0:b[a+d])}e.putImageData(k,0,0);q.src=e.canvas.toDataURL(m.mime);m.onStop()};s=q.src;h=h||{};for(var u in m)m[u]=h[u]||m[u];v&&r(v);return{apply:function(){s=q.src},vintage:r}};return this.each(function(){h.data(this,"vintageJS")||h.data(this,"vintageJS",new B(this,z,A))})}})(jQuery,window,document);
